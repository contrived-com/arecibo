{
  "$schema": "https://claudia.contrived.com/schemas/prompt.schema.json",
  "id": "arecibo-api-first-bootstrap",
  "title": "Arecibo API-First Bootstrap",
  "description": "Implement Arecibo API handlers from the OpenAPI contract, wire schema validation, and validate GO_DARK control flow end-to-end.",
  "authors": [
    {
      "name": "Sean",
      "type": "human"
    },
    {
      "name": "gpt-5.3-codex",
      "type": "model"
    }
  ],
  "createdAt": "2026-02-26T08:43:58Z",
  "status": "ready",
  "tags": [
    "arecibo",
    "api-first",
    "embedded-agent",
    "schemas",
    "go-dark",
    "observability"
  ],
  "content": "# Arecibo API-First Bootstrap\n\n## Context\n\nThis prompt assumes the implementing agent has already read:\n- `AGENTS.md` in this repository\n- `~/dev/homelab-infra/ECOSYSTEM.md`\n\nDo not restate ecosystem basics from those files in implementation notes.\n\n## Goal\n\nImplement the first working Arecibo control-plane + ingest API from the existing API-first contract and schema set, then validate the CEA lifecycle including rare GO_DARK behavior.\n\nThe implementation must treat `openapi.yml` as the source of truth and keep all endpoint behavior aligned with the OpenAPI contract.\n\n## Existing Contract Inputs (already in repo)\n\n- `openapi.yml`\n- `schemas/common/*.1.0.0.json`\n- `schemas/ingest/*.1.0.0.json`\n- `schemas/policy/*.1.0.0.json`\n- `schemas/api/result.1.0.0.json`\n\nCurrent expected CEA lifecycle:\n1. `POST /announce`\n2. `GET /policy`\n3. `POST /heartbeat` on policy cadence\n4. optional app datagrams -> CEA local socket\n5. `POST /events:batch` from CEA\n\n## Non-Negotiables\n\n1. **API-first discipline**\n   - OpenAPI contract comes first.\n   - If implementation needs behavior not represented in OpenAPI, update OpenAPI first.\n\n2. **Time standard**\n   - RFC 3339 timestamps in UTC with trailing `Z` only.\n\n3. **Primary application process term**\n   - Use the term **primary application process (PID 1)** in docs/messages.\n\n4. **GO_DARK semantics**\n   - GO_DARK means CEA process remains alive and stable.\n   - CEA may continue local ingest behavior but should stop outbound sends.\n   - This is intentionally a quiet, non-terminating safety state.\n\n## Implementation Scope (This Prompt)\n\n### 1) Add API service skeleton (`api/`)\n\nCreate a minimal Python API service (FastAPI preferred for current Contrived patterns) with:\n\n- Endpoint handlers for:\n  - `GET /health`\n  - `POST /announce`\n  - `GET /policy`\n  - `POST /heartbeat`\n  - `POST /events:batch`\n- API key auth via `X-API-Key`\n- Request/response schema validation wiring against existing JSON schemas\n- Structured JSON logging\n\nKeep dependencies minimal and implementation straightforward.\n\n### 2) Implement server-side result/directive model\n\nUse `schemas/api/result.1.0.0.json` as response envelope shape for non-health endpoints.\n\nSupport directives in responses (initially static/config-driven is fine):\n- `FLUSH_STATS`\n- `REFRESH_POLICY`\n- `GO_DARK`\n- `RESUME`\n- `SET_HEARTBEAT_INTERVAL`\n\n### 3) Policy fetch and session binding behavior\n\nImplement baseline policy behavior:\n\n- `GET /policy` returns `policy-response` with:\n  - `agentSessionId`\n  - `fetchedAt`\n  - `ttlSec`\n  - `policy`\n- Policy lookup can be in-memory/config-file for v1 (no DB required yet)\n- Validate `serviceName` + `environment`\n- Return contract-compliant result on missing policy\n\nSession handling v1 can be lightweight:\n- session can be generated on `announce` and echoed in policy response\n- strict persistence is not required in v1, but behavior must be deterministic enough for local testing\n\n### 4) Ingest behavior baseline\n\nImplement endpoint acceptance with validation and logging:\n\n- `POST /announce`: accept valid announce payload, log identity\n- `POST /heartbeat`: accept valid heartbeat payload, log key status metrics\n- `POST /events:batch`: accept valid batch payload, enforce max batch limits from schema, log counts\n\nNo full storage pipeline required yet, but implementation should leave clear extension points.\n\n### 5) Test plan + explicit GO_DARK scenario tests\n\nAdd tests that cover success and failure paths.\n\nMinimum tests:\n\n- Auth\n  - missing/invalid `X-API-Key` -> unauthorized responses\n  - valid key -> request accepted\n- Schema validation\n  - invalid timestamp (non-UTC `Z`) rejected\n  - missing required fields rejected\n- Policy\n  - known service/env returns `policy-response`\n  - unknown service/env returns expected error/result behavior\n- GO_DARK directives\n  - API can emit `GO_DARK` directive in `result.directives`\n  - document and test expected CEA-side interpretation contract\n\n**Important**: Add a deterministic test mode where API intentionally returns `GO_DARK` on heartbeat/events for verification. This exists specifically to test rare/failure-only behavior safely.\n\n### 6) Documentation updates\n\nUpdate docs so a new contributor can run and verify quickly:\n\n- where API code lives\n- how to configure API keys for local dev\n- how to run service locally\n- how to run tests\n- how to trigger GO_DARK test mode\n- how OpenAPI and schemas govern implementation changes\n\n## Suggested File Plan\n\n- `api/pyproject.toml` (or equivalent)\n- `api/src/app.py`\n- `api/src/auth.py`\n- `api/src/config.py`\n- `api/src/routes/*.py` (or a compact structure if preferred)\n- `api/src/schemas.py` (validation helpers)\n- `api/tests/test_auth.py`\n- `api/tests/test_policy.py`\n- `api/tests/test_ingest.py`\n- `api/tests/test_go_dark.py`\n- `api/README.md` or update root `README.md` with API run/test section\n\nAdjust structure if needed, but preserve clarity.\n\n## Acceptance Criteria\n\n1. OpenAPI endpoints in `openapi.yml` are implemented and routable.\n2. API key auth enforced for all non-health endpoints.\n3. Requests and responses conform to JSON schemas.\n4. `GET /policy` returns valid `policy-response` with `agentSessionId`.\n5. `POST /heartbeat` and `POST /events:batch` can return directive-bearing `result` envelopes.\n6. GO_DARK directive path is explicitly testable and covered by tests.\n7. Local run + test instructions are documented and work.\n8. No secrets committed to repository.\n\n## Out of Scope (for this prompt)\n\n- Full production persistence and retention strategy\n- Web UI implementation\n- Fleet-wide deployment automation\n- Advanced token/session issuance infrastructure\n\n## Implementation Notes\n\n- Prefer small, clear modules over over-engineered abstractions.\n- Keep behavior deterministic for tests.\n- Keep log fields stable and machine-parsable.\n- If OpenAPI and implementation conflict, update OpenAPI first, then implementation.\n"
}
