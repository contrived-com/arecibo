{
  "$schema": "https://claudia.contrived.com/schemas/prompt.schema.json",
  "id": "arecibo-homelab-infra-rollout",
  "title": "Arecibo Homelab Infrastructure Rollout",
  "description": "Configure homelab-infra to deploy and operate the Arecibo API service with nginx, systemd updater, service account, Vault-backed deploy auth, and TLS.",
  "authors": [
    {
      "name": "Sean",
      "type": "human"
    },
    {
      "name": "gpt-5.3-codex",
      "type": "model"
    }
  ],
  "createdAt": "2026-02-26T12:00:00Z",
  "status": "ready",
  "tags": [
    "arecibo",
    "homelab-infra",
    "deployment",
    "nginx",
    "systemd",
    "vault"
  ],
  "content": "# Arecibo Homelab Infrastructure Rollout\n\n## Context\n\nArecibo is now an API-first service in `contrived-com/arecibo` with a working FastAPI API under `api/` and schema-validated endpoints.\n\nWe need to wire production operations in `~/dev/homelab-infra` so Arecibo can be deployed and maintained on `onlogic-closet` using the same durable patterns as other services.\n\nThe goal is high reliability with two access modes:\n\n1. **External path**: `https://arecibo.contrived.com` via nginx + TLS\n2. **Internal path**: container/network-local service access for same-host services (to reduce DNS dependency where possible)\n\nThis prompt is only for homelab-infra and host wiring; application logic changes happen in `arecibo` repo.\n\n## Why\n\n- Standardize Arecibo on the existing homelab update model (Vault-backed deploy auth + systemd timer + update script).\n- Ensure observability/control plane endpoint is consistently reachable externally.\n- Keep architecture aligned with existing Contrived service conventions.\n- Preserve future expansion path to multi-container (`arecibo-api` + `arecibo-web`) without rethinking fundamentals.\n\n## Constraints and Decisions\n\n- Service account naming: `arecibo`\n- UID: `1014` for prod (reserve `1015` for future test; do not fully wire test now)\n- GHCR source: `ghcr.io/contrived-com/arecibo`\n- Public subdomain: `arecibo.contrived.com`\n- Host port mapping recommendation: `127.0.0.1:8032 -> container:8080`\n- Runtime secrets for API auth (e.g. X-API-Key seed/material) must be Vault-backed; no secrets in git\n- Deploy auth (PAT for git + GHCR) follows infra-owned standard at `secret/homelab/deploy-auth/arecibo`\n\n## Requested Work in homelab-infra\n\n### 1) Add service account support\n\nUpdate `scripts/setup-service-accounts.sh`:\n- Add `arecibo` as contrived-com service account with UID `1014`\n- Preserve even=prod / odd=test scheme comments\n- Reserve/document `1015` for future test usage\n\n### 2) Add nginx site for arecibo\n\nCreate `nginx/sites-available/arecibo.contrived.com` with:\n- HTTP -> HTTPS redirect\n- ACME challenge location\n- TLS server block for `arecibo.contrived.com`\n- Proxy to `http://127.0.0.1:8032`\n- Standard forwarded headers matching current service patterns\n\nThen include enablement instructions in the operational output (not necessarily auto-enable in repo):\n- symlink to `sites-enabled`\n- `nginx -t`\n- reload nginx\n\n### 3) Add update script\n\nCreate `scripts/arecibo/update-images.sh` following current robust service script patterns:\n- Vault-backed deploy auth via `scripts/lib/vault-ghcr-auth.sh`\n- Fetch `docker-compose.yml` from repo and validate before apply\n- Pull `ghcr.io/contrived-com/arecibo:latest`\n- Restart only when compose/image/config changes require it\n- Safety net: if all services down, bring up\n- Log to `/home/arecibo/logs/update.log`\n- Script must be executable\n\nExpected defaults in script:\n- `HOME_DIR=/home/arecibo`\n- `GHCR_PAT_VAULT_PATH=secret/homelab/deploy-auth/arecibo`\n- watch `.env` for mtime-based restart triggers\n\n### 4) Add systemd units\n\nCreate:\n- `systemd/arecibo-update.service`\n- `systemd/arecibo-update.timer`\n\nFollow existing naming/behavior conventions:\n- service runs as `arecibo`\n- timer cadence consistent with other services (frequent polling pattern)\n- unit executes `/home/arecibo/bin/update-images.sh`\n\n### 5) Add bashrc profile\n\nCreate `bashrc/arecibo.bashrc` consistent with service account profiles used elsewhere.\n\n### 6) Update docs/README status sections\n\nIn `homelab-infra/README.md`:\n- add symlink status entries for arecibo where appropriate:\n  - bashrc\n  - update script\n  - systemd service/timer\n  - nginx site\n- include arecibo in relevant setup/update script inventories\n\n## Host-side setup runbook (to include in output)\n\nProvide explicit commands for operator execution on `onlogic-closet`:\n\n1. Run service account setup script\n2. Create symlinks for bashrc/update script/systemd/nginx\n3. `systemctl daemon-reload` + enable timer\n4. DNS CNAME setup:\n   - `arecibo.contrived.com -> home.contrived.com`\n5. Certbot issuance for `arecibo.contrived.com`\n6. Nginx enable + reload\n7. First service start:\n   - `sudo -u arecibo docker compose -f /home/arecibo/docker-compose.yml up -d`\n\n## Verification checklist\n\nThe prompt output should include commands and expected outcomes:\n\n- `systemctl status arecibo-update.timer`\n- tail updater log\n- `docker ps` contains arecibo container\n- `curl -s http://127.0.0.1:8032/health` returns healthy JSON\n- `curl -s https://arecibo.contrived.com/health` returns healthy JSON\n- invalid auth request to non-health endpoint returns unauthorized result envelope\n\n## Acceptance Criteria\n\n1. homelab-infra contains all arecibo service artifacts (nginx, script, systemd, bashrc, setup-account update).\n2. UID allocation includes `arecibo` at `1014`, with `1015` reserved/documented.\n3. Update path uses Vault deploy-auth standard (`secret/homelab/deploy-auth/arecibo`).\n4. External HTTPS endpoint `arecibo.contrived.com` is wired to `127.0.0.1:8032`.\n5. README/status docs reflect new arecibo infra artifacts.\n6. Operator runbook commands are provided and coherent.\n\n## Out of Scope\n\n- Building or changing arecibo application code in this prompt\n- Implementing `arecibo-web` UI container now\n- Full test environment (`arecibo-test`) rollout\n- Secrets value provisioning itself (only wiring paths/expectations)\n\n## Notes for Future Expansion\n\nDesign choices should not block a near-future transition to multi-container compose (`arecibo-api` + `arecibo-web`) under the same service account and updater pattern.\n"
}
